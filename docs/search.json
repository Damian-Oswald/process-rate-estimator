[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Documentation of the Process Rate Estimator R package PRE",
    "section": "",
    "text": "Note\n\n\n\nThis repo is still very much work in progress.\n\n\n\n1 Preface\nThis site contains the documentation for the process rate estimator.\nFor a detailed (scientific) description of the process rate estimator, see (1).\n\n\n\n\n1. Decock, C. et al. Process rate estimator: A novel model to predict total denitrification using natural abundance stable isotopes of n 2 o. Biogeosciences Discussions 2022, 1–29 (2022)."
  },
  {
    "objectID": "introduction.html#background",
    "href": "introduction.html#background",
    "title": "2  Introduction",
    "section": "2.1 Background",
    "text": "2.1 Background\nDenitrification is the natural process by which nitrate (NO3-) in the soil are converted by bacteria into nitrous oxide (N2O) or pure nitrigen (N2). The latter is called total denitrification — the full process described in Equation 2.1 takes place.\n\\[\n\\ce{NO3^- -&gt;[\\text{Nitrate}][\\text{reductase}] NO2^- -&gt;[\\text{Nitrite}][\\text{reductase}] NO -&gt;[\\text{Nitrite oxide}][\\text{reductase}] N2O^- -&gt;[\\text{Nitrous oxide}][\\text{reductase}] N2}\n\\tag{2.1}\\]\nDenitrification occurs in conditions where oxygen is limited, such as waterlogged soils. It is part of the nitrogen cycle, where nitrogen is circulated between the atmosphere, organisms and the earth."
  },
  {
    "objectID": "introduction.html#installation-of-the-r-package-pre",
    "href": "introduction.html#installation-of-the-r-package-pre",
    "title": "2  Introduction",
    "section": "2.2 Installation of the R package PRE",
    "text": "2.2 Installation of the R package PRE\nAll functions that are used repeatedly throughout this projec are implemented in an R package called PRE. The source code of this package is stored in a publically accessible way on GitHub. You can install the package directly from GitHub using the install_github function from the remotes package.\n\ninstall.packages(\"remotes\")\nremotes::install_github(\"https://github.com/Damian-Oswald/PRE\")\n\nAlternatively, you could download the GitHub repository and manually install the PRE package locally. Once the package is installed, you can attach it to the search path in the usual way.\n\nlibrary(PRE)\n\n\n2.2.1 What do the various functions do?\nThe R code shown on this project help page is extremely simplified. If you want want to understand what a specific function of the PRE package does, simple visit the corresponding R help page. For example, you could read on the function crossValidate by using one of the the following commands.\n\nhelp(\"crossValidate\", package = \"PRE\")\n?crossValidate\n\nIf you want to jump really deep into a function, you could print it out in your console.\n\nprint(crossValidate)\n\nfunction (FUN, x, y, k = nrow(x), r = 1, hyperparameter = NULL) \n{\n    results &lt;- data.frame()\n    for (R in 1:r) {\n        I &lt;- matrix(c(sample(1:nrow(x)), rep(NA, k - nrow(x)%%k)), \n            ncol = k, byrow = TRUE)\n        for (K in 1:k) {\n            i &lt;- na.omit(I[, K])\n            result &lt;- cbind(cost = FUN(x_train = x[-i, ], y_train = y[-i, \n                ], x_test = x[i, ], y_test = y[i, ], hyperparameter = hyperparameter), \n                r = R, k = K)\n            results &lt;- rbind(results, result)\n        }\n    }\n    return(results)\n}\n&lt;bytecode: 0x7fcbc5b9b160&gt;\n&lt;environment: namespace:PRE&gt;\n\n\nNote this function source code output is lacking any comments. Those were automatically removed when compiling the R package. To see the commented source code, you’ll have to jump into the package files, or visit the GitHub page. Simply use the following URL:\nhttps://github.com/Damian-Oswald/PRE/blob/main/R/crossValidate.R\nNotice how the base name (the last part of the URL) matches the function name. You can replace that by any function name of your liking."
  },
  {
    "objectID": "data-preparation.html#description-of-the-measurements",
    "href": "data-preparation.html#description-of-the-measurements",
    "title": "3  Data preparation",
    "section": "3.1 Description of the measurements",
    "text": "3.1 Description of the measurements\nThe study uses data collected from a mesocosm experiment – i.e. an outdoor experiment that examines the natural environment under controlled conditions. The experiment was set up as a randomized complete block design, with 4 varieties and 3 replicates, using 12 non-weighted lysimeters. A non-weighted lysimeter is a device to measure the amount of water that drains through soil, and to determine the types and amounts of dissolved nutrients or contaminants in the water. Each lysimeter had five sampling ports with soil moisture probes and custom-built pore gas sample, at depths of 7.5, 30, 60, 90 and 120 cm below soil surface.\n\\[4 \\times 3 \\times 5 \\times 161 = 9660 \\tag{3.1}\\]\nEquation 3.1 shows how many observations we should expect to have. In reality, some observations are missing. Hence, the measurements data frame only includes 9558 rows, with 9 variables. Table 3.1 gives an overview of those variables.\n\n\n\nTable 3.1: Overview of the variables included in the measurements data as included in the R package PRE.\n\n\n\n\n\n\n\n\n\nCode\nName\nDescription\nClass\nMissing\n\n\n\n\ndate\nDate (YYYY-MM-DD)\n\n\"Date\"\n0%\n\n\ncolumn\nColumn\nOne out of twelve experimental units.\n\"ordered\"\n0%\n\n\ndepth\nMeasurement depth\nDepth of the measurement, either 7.5, 30, 60, 90, or 120 cm.\n\"numeric\"\n0%\n\n\nincrement\nHeight of a specific layer\n\n\"integer\"\n0%\n\n\nvariety\nWheat variety\nEither CH Claro, Monte Calme 268, Probus, or Zinal.\n\"factor\"\n0%\n\n\nmoisture\nSoil moisture\n\n\"numeric\"\n0%\n\n\nN2O\nCorrected N2O conc.\n\n\"numeric\"\n86.9%\n\n\nSP\nSite preference\nSite preference values for N2O\n\"numeric\"\n86.3%\n\n\nd18O\nStable isotope ratio\nRatio of stable isotopes oxygen-18 (18O) and oxygen-16 (16O).\n\"numeric\"\n86.3%\n\n\n\n\n\n\n3.1.1 Accessing the measurement data in R\nIn the R package PRE, this data is available as the object measurements. We can load the data with the data function in R.\n\ndata(\"measurements\", package = \"PRE\")\n\nUpon doing so, a data frame called measurements will appear in our global environment. Alternatively, the data can be directly accessed as PRE::measurements (the prefix PRE:: tells R that the object can be found in the PRE package.)\nYou can see an interactive overview of the measurements data in the column below. For many dates, there are no measurements of \\(\\ce{N2O}\\), site preference, or \\(\\delta^{18}\\text{O}\\).\n\n\n\n\n\n\n\n\n\n\n\nLuckily, the measurements for N2O concentration, site preference as well as \\(\\delta\\)18O are distributed more or less evenly over time. Hence, we’ll interpolate the missing values. This step will be the focus of the next section."
  },
  {
    "objectID": "data-preparation.html#calculating-volumetric-and-area-n2o-n",
    "href": "data-preparation.html#calculating-volumetric-and-area-n2o-n",
    "title": "3  Data preparation",
    "section": "3.2 Calculating volumetric and area N2O-N",
    "text": "3.2 Calculating volumetric and area N2O-N\nIn a first step, we are calculating the N2O-N per volume and subsequently per area. This is a necessary step, because the process rate estimator requires these variables.\nSince both N2ONvolume as well as N2ONarea are dependent on initial parameters, their computation is part of the workflow and might change slightly for a changed experimental set-up or different assumptions regarding the environment.\nThe volumetric N2O-N is calculated from the N2O concentration (Equation 3.2).\n\\[\\text N_2 \\text {O-N}_\\text{volume} =  \\frac{28[\\text{N}_2\\text O]}{\\text {R} \\cdot \\text {T}} \\tag{3.2}\\]\nHere, \\(\\text {R}\\) is the gas constant and \\(T\\) is the temperature. In a next step, we calculate the per-area N2O-N from the volumetric N2O-N and the soil moisture as well as the total porosity and the increment in meters.\n\\[\\text N_2 \\text {O-N}_\\text{area} = \\text N_2 \\text {O-N}_\\text{volume} \\times \\frac{1}{100} \\texttt{increment} \\times \\frac{10^4}{10^3} \\left(\\theta_t - \\texttt{moisture} \\right) \\tag{3.3}\\]\nAll of these equations are implemented in the getN2ON function. This function returns a data frame very similar to measurements, but with two extra columns for the computed N2ONvolume and N2ONarea variables.\n\ndata &lt;- getN2ON(data = PRE::measurements, parameters = getParameters())\n\nNote that the getParameters function simply returns a list with the default values for all necessary parameters such as the gas constant \\(\\text R\\) or the assumed air temperature \\(\\text T\\). If we wish to change these, we can pass alternative parameter values to the function. For example, we could assume an air temperature of 300 K with getParameters(temperature = 300). This makes sure that depended parameter values are updated as well."
  },
  {
    "objectID": "data-preparation.html#sec-interpolation",
    "href": "data-preparation.html#sec-interpolation",
    "title": "3  Data preparation",
    "section": "3.3 Interpolating the measurements",
    "text": "3.3 Interpolating the measurements\nThe N2O concentration, site preference as well as \\(\\delta\\)18O are estimated as a function of time for every depth and every column, separately. To achieve this function approximation, Kernel Regression as implemented in npreg is used (1). The model requires a single parameter, the bandwidth (bws), which defines how flexible it is. However, the bandwidth needs to be actively chosen and cannot be intrinsically estimated – it’s a hypertuning parameter a.k.a. a hyperparameter.\n\n3.3.1 Choosing optimal bandwidths for the interpolation\nFigure 3.1 gives an intuitive understanding on why we don’t want to use the same bandwidth for every single combination of depth and column: In some instances we seem to have a very clear signal, while in others, there seems to be much noise – we are dealing with unequal variance, a.k.a. heteroskedasticity.\n\n\n\nFigure 3.1: Animated explanation on two examplary subsets of the data. On the left, there is a very high sinal to noise ratio, thus the optimal bandwith hyperparameter will be smaller than on the right.\n\n\nThe bandwidth hyperparameter is individually tuned using 3-fold 10 times repeated cross-validation for every combination of column and depth and variable1, respectively. You can see an overview of the found hyperparameters in figure 3.2, 3.3, and 3.4.\n\nN2O concentrationSite preferenceStable isotope ratio (\\(\\delta\\)18O)\n\n\n\n\n\nFigure 3.2: Optimal hyperparameter size by depth and column for the N2O-N concentration.\n\n\n\n\n\n\n\nFigure 3.3: Optimal hyperparameter size by depth and column for the preference.\n\n\n\n\n\n\n\nFigure 3.4: Optimal hyperparameter size by depth and column for the \\(\\delta\\)18O concentration.\n\n\n\n\n\nGenerally, smaller bandwidths correspond to a more flexible model, indicating a larger signal-to-noise ratio. Notice how deeper measurements seem to correspond to smaller bandwidths, at least for the N2O concentration and the stable isotope ratio (\\(\\delta\\)18O). Note that the optimal bandwidths for N2O are also used for the interpolation of N2O-Nvolume and N2O-Narea.\n\n\n3.3.2 Using kernel regression for function estimation\nWith the optimized hyperparameters, we are all set to estimate the functions over time, as well as their derivatives, which are needed for the process rate estimator.\nOne common way to numerically approximate the derivative of a function \\(f\\) at a point \\(t\\) is through the central difference method. This method computes the average rate of change over a small interval around the point of interest.\n\\[\\frac{df}{dt} \\approx \\frac{f(t + h) - f(t - h)}{2h} \\tag{3.4}\\]\nHere, \\(h\\) is a small positive number known as the step size. The notations \\(f(t + h)\\) and \\(f(t - h)\\) represent the function values at \\(t + h\\) and \\(t - h\\), respectively. The smaller h is, the more accurate the approximation should be. However, if h is too small, then round-off errors from computer arithmetic can become significant. So, an appropriate balance must be struck. The central difference method is implemented as the fderiv function in the pracma R package.\nBoth the function estimation as well as the estimation of the derivative are performed with a single function call in the R package PRE.\n\ndata &lt;- getMissing(data = data, hyperparameters = PRE::hyperparameters)\n\nHere, data is the data frame that we slightly extended with the getN2ON function. The object hyperparameters is a three-dimensional array containing the optimized hyperparameters for this project. It is also included in the PRE package2."
  },
  {
    "objectID": "data-preparation.html#calculating-the-fluxes",
    "href": "data-preparation.html#calculating-the-fluxes",
    "title": "3  Data preparation",
    "section": "3.4 Calculating the fluxes",
    "text": "3.4 Calculating the fluxes\n\n3.4.1 Model parameters\n\n\nTable 3.2: Overview of the parameters used in the model.\n\n\n\n\n\n\n\n\n\nSymbol\nCode\nName\nValue\nUnit\n\n\n\n\n\\(BD\\)\nBD\nBulk density (mass of the many particles of the material divided by the bulk volume)\n\\(1.686\\)\ng cm-3\n\n\n\\(\\theta_w\\)\ntheta_w\nSoil volumetric water content\n\n\n\n\n\\(\\theta_a\\)\ntheta_a\nAir-filled porosity\n\\(1-\\frac{\\theta_w}{\\theta_t}\\)\n\n\n\n\\(\\theta_t\\)\ntheta_t\nTotal soil porosity\n\\(1-\\frac{BD}{2.65}\\)\n\n\n\n\\(\\text T\\)\ntemperature\nSoil temperature\n\\(298\\)\nK\n\n\n\\(D_{\\text{s}}\\)\nD_s\nGas diffusion coefficient\nEquation 3.6\nm2s-1\n\n\n\\(D_{\\text{fw}}\\)\nD_fw\nDiffusivity of N2O in water\nEquation 3.8\n\n\n\n\\(D_{\\text{fa}}\\)\nD_fa\nDiffusivity of N2O in air\nEquation 3.9\n\n\n\n\\(D_{\\text{fa,NTP}}\\)\n\nFree air diffusion coefficient under standard conditions\nEquation 3.9\n\n\n\n\\(n\\)\nn\nEmpirical parameter (2)\n1.81\n\n\n\n\\(H\\)\nH\nDimensionless Henry’s solubility constant\nEquation 3.7\n\n\n\n\\(\\rho\\)\nrho\nGas density of N2O\n\\(1.26 \\times 10^6\\)\nmg m-3\n\n\n\n\nThe diffusion fluxes between soil increments are described by Frick’s law (Equation 3.5).\n\\[F_{\\text{calc}} = \\frac{dC}{dZ} D_{\\text s} \\rho \\tag{3.5}\\]\nHere, \\(D_s\\) is the gas diffusion coefficient, \\(\\rho\\) is the gas density of N2O, and \\(\\frac{dC}{dZ}\\) is the N2O concentration gradient from lower to upper depth. The fluxes are calculated based on N2O concentration gradients between 105-135 cm, 75-105 cm, 45-75 cm, 15-45 cm, and 0-15 cm depth layers, and ambient air above the soil surface.\n\\(\\theta_w\\) is the soil volumetric water content, \\(\\theta_a\\) the air-filled porosity, and \\(\\theta_T\\) is the total soil porosity.\nThe gas diffusion coefficient \\(D_{\\text s}\\) was calculated according Equation 3.6 as established by Millington and Quirk in 1961 (3).\n\\[D_{\\text s} = \\left( \\frac{\\theta_w^{\\frac{10}{3}} + D_{\\text fw}}{H} + \\theta_a^{\\frac{10}{3}} \\times D_{\\text fa} \\right) \\times \\theta_T^{-2} \\tag{3.6}\\]\nHere, \\(H\\) represents a dimensionless form of Henry’s solubility constant (\\(H'\\)) for N2O in water at a given temperature. The constant \\(H\\) for N2O is calculated as follows:\n\\[H = \\frac{8.5470 \\times 10^5 \\times \\exp \\frac{-2284}{\\text T}}{\\text R \\times \\text T} \\tag{3.7}\\]\nHere, \\(\\text R\\) is the gas constant, and \\(\\text T\\) is the temperature (\\(\\text T = 298 \\; \\text K\\)).\n\\(D_{\\text{fw}}\\) was calculated according to Equation 3.8 as documented by Versteeg and Van Swaaij (1988) (4).\n\\[D_{\\text{fw}} = 5.07 \\times 10^{-6} \\times \\exp \\frac{-2371}{\\text T} \\tag{3.8}\\]\n\\[D_{\\text{fa}} = D_{\\text{fa, NTP}} \\times \\left( \\frac{\\text T}{273.15} \\right)^n \\times \\left( \\frac{101'325}{\\text P} \\right) \\tag{3.9}\\]\n\n\n3.4.2 State function set\nThe process rate estimator includes three-state functions, describing the change in N2O concentrations over time. The change in N2O concentrations in each depth increment over time \\(\\frac{d}{dt}[\\ce{N2O}]\\) depends on the flux of N2O entering the depth increment from the top or the bottom through diffusion (\\(F_{top,in}\\) and \\(F_{bot,in}\\), respectively), the flux of N2O leaving the depth increment through diffusion (\\(F_{out}\\)), the rate of N2O produced through nitrification (N2Onit), the rate of N2O produced through denitrification (N2Oden), and the rate of N2O reduced to N2 (N2Ored).\n\\[\\frac{\\Delta[\\ce{N2O}]}{\\Delta t} = F_{top} + F_{bottom}  + \\ce{N2O}_{\\text{nitrification}} + \\ce{N2O}_{\\text{denitrification}} + \\ce{N2O}_{\\text{reduction}} \\tag{3.10}\\]\n\\[\\frac{\\Delta \\text{SP}}{\\Delta t} = F_{t,i}(\\text{SP}_{t,i} - \\eta_{SP,dif} - \\text{SP}_0) + F_{b,i}(\\text{SP}_{b,i}) ... \\tag{3.11}\\]\n\n\n\n\n1. Hayfield, T. & Racine, J. S. Nonparametric econometrics: The np package. Journal of Statistical Software 27, 1–32 (2008).\n\n\n2. Massman, W. A review of the molecular diffusivities of H2O, CO2, CH4, CO, O3, SO2, NH3, N2O, NO, and NO2 in air, O2 and N2 near STP. Atmospheric environment 32, 1111–1127 (1998).\n\n\n3. Millington, R. & Quirk, J. Permeability of porous solids. Transactions of the Faraday Society 57, 1200–1207 (1961).\n\n\n4. Versteeg, G. F. & Van Swaaij, W. P. Solubility and diffusivity of acid gases (carbon dioxide, nitrous oxide) in aqueous alkanolamine solutions. Journal of Chemical & Engineering Data 33, 29–34 (1988)."
  },
  {
    "objectID": "data-preparation.html#footnotes",
    "href": "data-preparation.html#footnotes",
    "title": "3  Data preparation",
    "section": "",
    "text": "I.e. the three variables N2O concentration, site preference and \\(\\delta\\)18O.↩︎\nTo optimize the hyperparameters, you can run the R script hypertuning.R.↩︎"
  },
  {
    "objectID": "running-the-model.html#install-the-r-package-pre",
    "href": "running-the-model.html#install-the-r-package-pre",
    "title": "4  Running the process rate estimator",
    "section": "4.1 Install the R package PRE",
    "text": "4.1 Install the R package PRE\nYou can directly install this R package from GitHub. The package itself already contains all data and parameters necessary to run the process rate estimator.\n\ninstall.packages(\"remotes\")\nremotes::install_github(\"https://github.com/Damian-Oswald/PRE\")\n\nOnce installed, add the package to the search path.\n\nlibrary(PRE)"
  },
  {
    "objectID": "running-the-model.html#prepare-the-data",
    "href": "running-the-model.html#prepare-the-data",
    "title": "4  Running the process rate estimator",
    "section": "4.2 Prepare the data",
    "text": "4.2 Prepare the data\nIn a first step, we can calculate the N2O-N from the original measurements.\n\noriginal &lt;- getN2ON(data = measurements, parameters = parameters)\n\nNext, the data are interpolated. This process uses kernel regression to interpolate between the measured values of N2O-N, SP and d18O.\n\ndata &lt;- getMissing(data = data, hyperparameters = hyperparameters)\n\nWith all of these steps done, we can calculate the Fluxes according to equations 1, 2, 3.\n\ndata &lt;- calculateFluxes(data = data, parameters = parameters)\n\nNow, everything is ready to run the PRE."
  },
  {
    "objectID": "running-the-model.html#running-the-process-rate-estimator",
    "href": "running-the-model.html#running-the-process-rate-estimator",
    "title": "4  Running the process rate estimator",
    "section": "4.3 Running the process rate estimator",
    "text": "4.3 Running the process rate estimator\n\n# run the solver once\nx &lt;- PRE(data = data, column = 1, depth = 7.5, date = \"2016-01-01\", n = 200)\n\n# print out information\nprint(x)\n\n# plot\nplot(x)\n\n# pairs panel\npairs(x)"
  },
  {
    "objectID": "results.html",
    "href": "results.html",
    "title": "5  Results",
    "section": "",
    "text": "TODO: Make a panel tabset to go through all results.\n\nColumn 123456789101112\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nDepth = 7.5 cm30 cm60 cm90 cm120 cm"
  },
  {
    "objectID": "references.html",
    "href": "references.html",
    "title": "References",
    "section": "",
    "text": "1. Decock, C. et al. Process rate\nestimator: A novel model to predict total denitrification using natural\nabundance stable isotopes of n 2 o. Biogeosciences Discussions\n2022, 1–29 (2022).\n\n\n2. Hayfield, T. & Racine, J. S. Nonparametric econometrics:\nThe np package. Journal of Statistical Software\n27, 1–32 (2008).\n\n\n3. Massman, W. A review of the molecular\ndiffusivities of H2O, CO2, CH4, CO, O3, SO2, NH3, N2O, NO, and NO2 in\nair, O2 and N2 near STP. Atmospheric environment\n32, 1111–1127 (1998).\n\n\n4. Versteeg, G. F. & Van Swaaij, W. P.\nSolubility and diffusivity of acid gases (carbon dioxide, nitrous oxide)\nin aqueous alkanolamine solutions. Journal of Chemical &\nEngineering Data 33, 29–34 (1988).\n\n\n5. Millington, R. & Quirk, J. Permeability of\nporous solids. Transactions of the Faraday Society\n57, 1200–1207 (1961)."
  }
]