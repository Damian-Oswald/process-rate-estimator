---
title: Running the process rate estimator
execute: 
  eval: false
  echo: true
---

### State function set

The process rate estimator includes three-state functions, describing the change in N~2~O concentrations over time.
The change in N~2~O concentrations in each depth increment over time $\frac{d}{dt}[\ce{N2O}]$ depends on the flux of N~2~O entering the depth increment from the top or the bottom through diffusion ($F_{top,in}$ and $F_{bot,in}$, respectively), the flux of N~2~O leaving the depth increment through diffusion ($F_{out}$), the rate of N~2~O produced through nitrification (`N2Onit`), the rate of N~2~O produced through denitrification (`N2Oden`), and the rate of N~2~O reduced to N~2~ (`N2Ored`).

$$\frac{d[\ce{N2O}]}{d t} = \text F_{\text{top,in}} + \text F_{\text{bottom,in}}  + \ce{N2O}_{\text{nit.}} + \ce{N2O}_{\text{den.}} + \ce{N2O}_{\text{red.}}$${#eq-stateN2O}

For the equation of the change of site preference over time, we'll use the substitutions $A$, $B$ and $C$, as the expression is rather long.

$$\frac{d \text{SP}}{d t} = \frac{A + B + C}{[\ce{N2O}]}$${#eq-stateSP}


$$A = \text F_{\text{top,in}}(\text{SP}_{\text{top,in}} - \eta\: \text{SP}_\text{diff.} - \text{SP}) + \text F_{\text{bottom,in}}(\text{SP}_{\text{bottom,in}} - \eta\: \text{SP}_\text{diff.} - \text{SP})$$
$$B = \ce{N2O}_{\text{nit.}}(\text{SP}_\text{nit.} - \text{SP}) + \ce{N2O}_{\text{den.}}(\text{SP}_\text{den.} - \text{SP})$$
$$C = - \eta\: \text{SP}_\text{diff.} \text F_{\text{out}} - \eta\ce{^{18}O_\text{red.}} \ce{N2O}_{\text{red.}}$$


## Install the R package `PRE`

You can directly install this R package from GitHub. The package itself already contains all data and parameters necessary to run the process rate estimator.

```{r}
install.packages("remotes")
remotes::install_github("https://github.com/Damian-Oswald/PRE")
```

Once installed, add the package to the search path.

```{r}
library(PRE)
```

## Prepare the data

In a first step, we can calculate the N~2~O-N from the original measurements.

```{r}
original <- getN2ON(data = measurements, parameters = parameters)
```

Next, the data are interpolated. This process uses kernel regression to interpolate between the measured values of N~2~O-N, SP and d18O.

```{r}
data <- getMissing(data = data, hyperparameters = hyperparameters)
```

With all of these steps done, we can calculate the Fluxes according to equations 1, 2, 3.

```{r}
data <- calculateFluxes(data = data, parameters = parameters)
```

Now, everything is ready to run the PRE.

## Running the process rate estimator

```{r}
# run the solver once
x <- PRE(data = data, column = 1, depth = 7.5, date = "2016-01-01", n = 200)

# print out information
print(x)

# plot
plot(x)

# pairs panel
pairs(x)
```